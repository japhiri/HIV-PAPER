#!/bin/bash

STARSOLO_INDEX_DIR="/data/vita/starsolo_index"
FASTQ_DIR="/data/vita/star"
OUTPUT_DIR="/data/vita/starsolo_output"
WHITELIST_FILE="/data/vita/whitelist.txt"
THREADS=8

mkdir -p ${OUTPUT_DIR}

echo "Aligning FASTQ files with STARsolo..."
for fastq_file1 in ${FASTQ_DIR}/*_1.fastq.gz; do
    base_name=$(basename ${fastq_file1} _1.fastq.gz)
    fastq_file2="${FASTQ_DIR}/${base_name}_2.fastq.gz"
    output_dir="${OUTPUT_DIR}/${base_name}_"

    if [ -f "${fastq_file2}" ]; then
        STAR --runThreadN ${THREADS} \
             --genomeDir ${STARSOLO_INDEX_DIR} \
             --readFilesIn ${fastq_file1} ${fastq_file2} \
             --readFilesCommand zcat \
             --outFileNamePrefix ${output_dir} \
             --soloType CB_UMI_Simple \
             --soloCBwhitelist ${WHITELIST_FILE} \
             --soloUMIlen 7 \
             --soloCBlen 6 \
             --soloBarcodeReadLength 0 \
             --soloFeatures Gene
    else
        echo "Skipping ${base_name} due to missing pair file."
    fi
done

echo "STARsolo alignment process completed!"